<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="app_title">NeuroGuessr Web - Welcome</title>
    <link rel="stylesheet" href="niivue.css" />
  </head>
  <body class="index-page">
    <header>
      <div class="logo-title-container">
        <img src="/neuroguessr_web/data/neuroguessr.png" alt="NeuroGuessr Logo" class="logo" />
        <h1 data-i18n="app_title">NeuroGuessr</h1>
      </div>
      <div class="language-switcher">
        <button class="lang-btn" data-lang="fr">FR</button>
        <button class="lang-btn" data-lang="en">EN</button>
      </div>
    </header>

    <main>
      <div class="selection-container">
        <section class="atlas-selection">
          <div class="search-container">
            <h2 data-i18n="neuroglossaire_title">NeuroGlossaire - Search for a brain region</h2>
            <input
              type="text"
              id="atlas-search"
              data-i18n="[placeholder]search_placeholder"
              class="search-input"
            />
            <div id="search-suggestions" class="search-suggestions"></div>
          </div>
          <h2 data-i18n="select_atlas">Select Atlas</h2>
          <div class="atlas-layout">
            <div class="category-list">
              <button class="category-button" data-category="cortex" data-i18n="cortical_regions">Cortical Regions</button>
              <button class="category-button" data-category="subcortical" data-i18n="subcortical_regions">Subcortical Regions</button>
              <button class="category-button" data-category="white-matter" data-i18n="white_matter_tracts">White Matter Tracts</button>
              <button class="category-button" data-category="functional" data-i18n="functional_networks">Functional Networks</button>
              <button class="category-button" data-category="cerebral-arteries" data-i18n="cerebral_arteries">Cerebral Arteries</button>
            </div>
            <div class="atlas-choices-display"></div>
          </div>
          <div style="display: none;">
            <div id="atlas-buttons-cortex">
              <button class="panel-button" data-atlas="tissues">
                <span class="atlas-info" data-i18n="[html]tissues_info">Tissue classes <span class="atlas-description">Tissue types (CSF, WM, GM)</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="harvard-oxford">
                <span class="atlas-info" data-i18n="[html]harvard_oxford_info">Harvard-Oxford <span class="atlas-description">Probabilistic anatomical regions</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="aal">
                <span class="atlas-info" data-i18n="[html]aal_info">AAL <span class="atlas-description">Automated Anatomical Labeling</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="destrieux">
                <span class="atlas-info" data-i18n="[html]destrieux_info">Destrieux <span class="atlas-description">Gyral-sulcal parcellation</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="glasser">
                <span class="atlas-info" data-i18n="[html]glasser_info">Glasser <span class="atlas-description">Multimodal cortical parcellation</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
            </div>
            <div id="atlas-buttons-functional">
              <button class="panel-button" data-atlas="yeo7">
                <span class="atlas-info" data-i18n="[html]yeo7_info">Yeo's 7 networks <span class="atlas-description">7 resting-state functional networks</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="yeo17">
                <span class="atlas-info" data-i18n="[html]yeo17_info">Yeo's 17 networks <span class="atlas-description">17 resting-state functional networks</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
            </div>
            <div id="atlas-buttons-subcortical">
              <button class="panel-button" data-atlas="subcortical">
                <span class="atlas-info" data-i18n="[html]subcortical_info">Subcortical <span class="atlas-description">Deep brain structures</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="cerebellum">
                <span class="atlas-info" data-i18n="[html]cerebellum_info">Cerebellum <span class="atlas-description">Cerebellar regions</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="thalamus">
                <span class="atlas-info" data-i18n="[html]thalamus_info">Thalamus <span class="atlas-description">Thalamic nuclei</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="HippoAmyg">
                <span class="atlas-info" data-i18n="[html]hippo_amyg_info">Amygdala/Hippocampus <span class="atlas-description">Amygdala/Hippocampus subfields</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
            </div>
            <div id="atlas-buttons-white-matter">
              <button class="panel-button" data-atlas="JHU">
                <span class="atlas-info" data-i18n="[html]jhu_info">JHU <span class="atlas-description">JHU's White matter tracts</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="xtract">
                <span class="atlas-info" data-i18n="[html]xtract_info">White Matter <span class="atlas-description">FSL's White matter tracts</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
            </div>
            <div id="atlas-buttons-cerebral-arteries">
            </div>
          </div>
        </section>

        <section class="mode-selection">
          <h2 data-i18n="select_game_mode">Select Game Mode</h2>
          <div class="mode-buttons">
            <button class="mode-button" data-mode="navigation">
              <img src="/neuroguessr_web/data/boussole.png" alt="Boussole Icon" />
              <span data-i18n="navigation_mode">Navigation</span>
              <span class="mode-description" data-i18n="navigation_description">Identify brain regions</span>
            </button>
            <button class="mode-button" data-mode="practice">
              <img src="/neuroguessr_web/data/practice.png" alt="Practice Icon" />
              <span data-i18n="practice_mode">Practice</span>
              <span class="mode-description" data-i18n="practice_description">Learn with feedback</span>
            </button>
            <button class="mode-button" data-mode="streak">
              <img src="/neuroguessr_web/data/flame.png" alt="Flame Icon" />
              <span data-i18n="streak_mode">Streak</span>
              <span class="mode-description" data-i18n="streak_description">Test consecutive accuracy</span>
            </button>
            <button class="mode-button" data-mode="time-attack">
              <img src="/neuroguessr_web/data/chronometer.png" alt="Chronometer Icon" />
              <span data-i18n="time_attack_mode">Time Attack</span>
              <span class="mode-description" data-i18n="time_attack_description">Race against time</span>
            </button>
          </div>
          <button id="play-button" class="play-button" disabled data-i18n="play_button">Play</button>
        </section>
      </div>
    </main>

    <div id="notification"></div>

    <script src="https://unpkg.com/i18next@23.15.1/dist/umd/i18next.min.js"></script>
    <script>
      // Initialize i18next
      i18next.init({
        lng: localStorage.getItem('language') || 'en',
        resources: {
          en: { translation: {} },
          fr: { translation: {} }
        }
      }, function(err, t) {
        updateContent();
      });

      // Load translation files
      Promise.all([
        fetch('/neuroguessr_web/data/i18n/en.json').then(res => res.json()),
        fetch('/neuroguessr_web/data/i18n/fr.json').then(res => res.json())
      ]).then(([en, fr]) => {
        i18next.addResourceBundle('en', 'translation', en);
        i18next.addResourceBundle('fr', 'translation', fr);
        updateContent();
      });

      function updateContent() {
        document.querySelectorAll('[data-i18n]').forEach(elem => {
          const key = elem.getAttribute('data-i18n');
          if (key.startsWith('[html]')) {
            elem.innerHTML = i18next.t(key.replace('[html]', ''));
          } else if (key.startsWith('[')) {
            const [attr, k] = key.match(/\[(.+)\](.+)/).slice(1);
            elem.setAttribute(attr, i18next.t(k));
          } else {
            elem.textContent = i18next.t(key);
          }
        });
      }

      // Language switcher
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const lang = btn.dataset.lang;
          i18next.changeLanguage(lang, () => {
            localStorage.setItem('language', lang);
            updateContent();
            loadAtlasLabels().then(() => {
              searchAtlasRegions(searchInput.value);
            });
          });
        });
      });

      // Get references to UI elements
      const modeButtons = document.querySelectorAll('.mode-button');
      const playButton = document.getElementById('play-button');
      const notification = document.getElementById('notification');
      const categoryButtons = document.querySelectorAll('.category-button');
      const atlasChoicesDisplay = document.querySelector('.atlas-choices-display');
      const searchInput = document.getElementById('atlas-search');
      const searchSuggestions = document.getElementById('search-suggestions');

      // Variables to store user selections
      let selectedAtlas = null;
      let selectedMode = null;
      let selectedCategoryButton = null;
      let atlasRegions = [];

      // Atlas configuration
      const atlasFiles = {
        'aal': { nii: '/neuroguessr_web/data/aal.nii.gz', json: '/neuroguessr_web/data/aal.json', json_fr: '/neuroguessr_web/data/aal_fr.json', viewer: 'neurotheka.html', name: 'AAL' },
        'harvard-oxford': { nii: '/neuroguessr_web/data/HarvardOxford-cort-maxprob-thr25-1mm.nii.gz', json: '/neuroguessr_web/data/harvard_oxford.json', json_fr: '/neuroguessr_web/data/harvard_oxford_fr.json', viewer: 'neurotheka.html', name: 'Harvard-Oxford' },
        'tissues': { nii: '/neuroguessr_web/data/mni152_pveseg.nii.gz', json: '/neuroguessr_web/data/tissue.json', json_fr: '/neuroguessr_web/data/tissue_fr.json', viewer: 'neurotheka.html', name: 'Tissue' },
        // 'hemisphere': { nii: '/neuroguessr_web/data/Hemispheric_space-MNI152NLin6_res-1x1x1.nii.gz', json: '/neuroguessr_web/data/hemisphere.json', json_fr: '/neuroguessr_web/data/hemisphere_fr.json', viewer: 'neurotheka.html', name: 'Hemisphere' },
        // 'brodmann': { nii: '/neuroguessr_web/data/brodmann_grid.nii.gz', json: '/neuroguessr_web/data/brodmann.json', json_fr: '/neuroguessr_web/data/brodmann_fr.json', viewer: 'neurotheka.html', name: 'Brodmann' },
        'glasser': { nii: '/neuroguessr_web/data/HCP-MMP1_on_MNI152_ICBM2009a_nlin_hd.nii.gz', json: '/neuroguessr_web/data/glasser_neuroparc.json', json_fr: '/neuroguessr_web/data/glasser_neuroparc_fr.json', viewer: 'neurotheka.html', name: 'Glasser' },
        'destrieux': { nii: '/neuroguessr_web/data/Destrieux_space-MNI152NLin6_res-1x1x1.nii.gz', json: '/neuroguessr_web/data/destrieux.json', json_fr: '/neuroguessr_web/data/destrieux_fr.json', viewer: 'neurotheka.html', name: 'Destrieux' },
        // 'schaefer': { nii: '/neuroguessr_web/data/Schaefer2018_100Parcels_7Networks_order_FSLMNI152_1mm.nii.gz', json: '/neuroguessr_web/data/schaefer100.json', json_fr: '/neuroguessr_web/data/schaefer100_fr.json', viewer: 'neurotheka.html', name: 'Schaefer' },
        'yeo7': { nii: '/neuroguessr_web/data/Yeo-7-liberal_space-MNI152NLin6_res-1x1x1.nii.gz', json: '/neuroguessr_web/data/yeo7.json', json_fr: '/neuroguessr_web/data/yeo7_fr.json', viewer: 'neurotheka.html', name: 'Yeo7' },
        'yeo17': { nii: '/neuroguessr_web/data/Yeo-17-liberal_space-MNI152NLin6_res-1x1x1.nii.gz', json: '/neuroguessr_web/data/yeo17.json', json_fr: '/neuroguessr_web/data/yeo17_fr.json', viewer: 'neurotheka.html', name: 'Yeo17' },
        'subcortical': { nii: '/neuroguessr_web/data/ICBM2009b_asym-SubCorSeg-1mm_nn_regrid.nii.gz', json: '/neuroguessr_web/data/subcortical.json', json_fr: '/neuroguessr_web/data/subcortical_fr.json', viewer: 'neurotheka.html', name: 'Subcortical' },
        'cerebellum': { nii: '/neuroguessr_web/data/Cerebellum-MNIfnirt-maxprob-thr25-1mm.nii.gz', json: '/neuroguessr_web/data/cerebellum.json', json_fr: '/neuroguessr_web/data/cerebellum_fr.json', viewer: 'neurotheka.html', name: 'Cerebellum' },
        'xtract': { nii: '/neuroguessr_web/data/xtract_web.nii.gz', json: '/neuroguessr_web/data/xtract_labels.json', json_fr: '/neuroguessr_web/data/xtract_labels_fr.json', viewer: 'neurotheka.html', name: 'White Matter' },
        'thalamus': { nii: '/neuroguessr_web/data/Thalamus_Nuclei-HCP-MaxProb.nii.gz', json: '/neuroguessr_web/data/thalamus7.json', json_fr: '/neuroguessr_web/data/thalamus7_fr.json', viewer: 'neurotheka.html', name: 'Thalamus' },
        'HippoAmyg': { nii: '/neuroguessr_web/data/HippoAmyg_web.nii.gz', json: '/neuroguessr_web/data/HippoAmyg_labels.json', json_fr: '/neuroguessr_web/data/HippoAmyg_labels_fr.json', viewer: 'neurotheka.html', name: 'Hippocampus & Amygdala' },
        'JHU': { nii: '/neuroguessr_web/data/JHU_web.nii.gz', json: '/neuroguessr_web/data/JHU_labels.json', json_fr: '/neuroguessr_web/data/JHU_labels_fr.json', viewer: 'neurotheka.html', name: 'JHU' },
        'territories': { nii: '/neuroguessr_web/data/ArterialAtlas_round.nii.gz', json: '/neuroguessr_web/data/artery_territories.json', json_fr: '/neuroguessr_web/data/artery_territories_fr.json', viewer: 'neurotheka.html', name: 'Territories' }
      };

      // Display notification
      function showNotification(messageKey, isSuccess, params = {}) {
        notification.textContent = i18next.t(messageKey, params);
        notification.className = isSuccess ? 'success' : 'error';
        notification.style.display = 'block';
        setTimeout(() => {
          notification.style.display = 'none';
        }, 3000);
      }

      // Show previous game score if available
      const urlParams = new URLSearchParams(window.location.search);
      const score = urlParams.get('score');
      const time = urlParams.get('time');
      if (score && time) {
        const minutes = Math.floor(time / 60);
        const seconds = (time % 60).toString().padStart(2, '0');
        showNotification('previous_game', true, { accuracy: score, minutes, seconds });
      } else if (score) {
        showNotification('previous_streak', true, { streak: score });
      }

      // Update mode buttons based on selected atlas
      function updateModeButtons() {
        modeButtons.forEach(button => {
          button.disabled = false;
          if (selectedAtlas === 'glasser') {
            button.disabled = button.dataset.mode !== 'navigation';
            if (button.disabled) button.classList.remove('selected');
          } else if (selectedAtlas === 'hemisphere') {
            button.disabled = button.dataset.mode === 'navigation';
            if (button.disabled) button.classList.remove('selected');
          }
        });
        if (selectedAtlas === 'glasser' && selectedMode && selectedMode !== 'navigation') {
          selectedMode = null;
          modeButtons.forEach(btn => btn.classList.remove('selected'));
        }
        if (selectedAtlas === 'hemisphere' && selectedMode === 'navigation') {
          selectedMode = null;
          modeButtons.forEach(btn => {
            if (btn.dataset.mode === 'navigation') btn.classList.remove('selected');
          });
        }
      }

      // Update play button state
      function updatePlayButton() {
        playButton.disabled = !(selectedAtlas && selectedMode);
        playButton.classList.toggle('enabled', !playButton.disabled);
      }

      // Load labels for all atlases
      async function loadAtlasLabels() {
        atlasRegions = [];
        const lang = i18next.language;
        for (const [atlas, { json, json_fr, name }] of Object.entries(atlasFiles)) {
          try {
            const jsonFile = lang === 'fr' && json_fr ? json_fr : json;
            const response = await fetch(jsonFile);
            if (!response.ok) throw new Error(`HTTP ${response.status} for ${atlas}`);
            const labels = await response.json();
            const regions = Object.entries(labels.labels)
              .filter(([id]) => Number(id) > 0 && Number.isInteger(Number(id)))
              .map(([id, label]) => ({
                id: Number(id),
                name: label || `Region ${id}`,
                atlas,
                atlasName: name
              }));
            atlasRegions.push(...regions);
            console.log(`Loaded ${regions.length} regions for ${atlas} (${name})`);
          } catch (error) {
            console.error(`Failed to load labels for ${atlas}:`, error);
            showNotification('error_loading_atlas', false, { atlas: name });
          }
        }
        console.log('Total regions loaded:', atlasRegions.length);
        if (atlasRegions.length === 0) {
          showNotification('no_regions_loaded', false);
          searchInput.disabled = true;
        }
      }

      // Search across all atlas regions
      function searchAtlasRegions(query) {
        searchSuggestions.innerHTML = '';
        if (!query.trim()) {
          searchSuggestions.style.display = 'none';
          return;
        }
        const lowerQuery = query.toLowerCase();
        const matches = atlasRegions
          .filter(region => region.name.toLowerCase().includes(lowerQuery))
          .sort((a, b) => {
            const aIndex = a.name.toLowerCase().indexOf(lowerQuery);
            const bIndex = b.name.toLowerCase().indexOf(lowerQuery);
            if (aIndex !== bIndex) return aIndex - bIndex;
            return a.name.length - b.name.length;
          });
        if (matches.length === 0) {
          searchSuggestions.style.display = 'none';
          return;
        }
        matches.forEach(region => {
          const suggestion = document.createElement('div');
          suggestion.className = 'search-suggestion';
          suggestion.innerHTML = `${region.name} <span style="color: #808588;">(${region.atlasName})</span>`;
          suggestion.dataset.regionId = region.id;
          suggestion.dataset.atlas = region.atlas;
          suggestion.addEventListener('click', () => {
            const viewerUrl = `${atlasFiles[region.atlas].viewer}?region=${region.id}&atlas=${region.atlas}`;
            console.log(`Navigating to: ${viewerUrl}`);
            window.location.href = viewerUrl;
          });
          searchSuggestions.appendChild(suggestion);
        });
        searchSuggestions.style.display = 'block';
      }

      // Event listeners
      searchInput.addEventListener('input', () => {
        console.log('Search input:', searchInput.value);
        searchAtlasRegions(searchInput.value);
      });

      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
          searchSuggestions.style.display = 'none';
        }
      });

      categoryButtons.forEach(button => {
        button.addEventListener('click', () => {
          console.log('Category button clicked:', button.dataset.category);
          if (selectedCategoryButton) {
            selectedCategoryButton.classList.remove('selected');
          }
          button.classList.add('selected');
          selectedCategoryButton = button;

          atlasChoicesDisplay.innerHTML = '';
          selectedAtlas = null;
          updateModeButtons();
          updatePlayButton();

          const category = button.dataset.category;
          const atlasButtonsContainer = document.getElementById(`atlas-buttons-${category}`);
          if (!atlasButtonsContainer) {
            console.error(`No container found for category: ${category}`);
            atlasChoicesDisplay.innerHTML = `<p class="no-atlas-message">${i18next.t('no_atlas_message')}</p>`;
            return;
          }

          const atlasButtons = atlasButtonsContainer.querySelectorAll('.panel-button');
          if (atlasButtons.length === 0) {
            console.error(`No atlas buttons found for category: ${category}`);
            atlasChoicesDisplay.innerHTML = `<p class="no-atlas-message">${i18next.t('no_atlas_message')}</p>`;
            return;
          }

          atlasButtons.forEach(template => {
            const clone = template.cloneNode(true);
            clone.addEventListener('click', () => {
              console.log('Atlas button clicked:', clone.dataset.atlas);
              atlasChoicesDisplay.querySelectorAll('.panel-button').forEach(btn => btn.classList.remove('selected'));
              clone.classList.add('selected');
              selectedAtlas = clone.dataset.atlas;
              updateModeButtons();
              updatePlayButton();
            });
            atlasChoicesDisplay.appendChild(clone);
          });
        });
      });

      modeButtons.forEach(button => {
        button.addEventListener('click', () => {
          if (!button.disabled) {
            console.log('Mode button clicked:', button.dataset.mode);
            modeButtons.forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedMode = button.dataset.mode;
            updatePlayButton();
          }
        });
      });

      playButton.addEventListener('click', () => {
        if (!playButton.disabled) {
          console.log('Play button clicked:', selectedAtlas, selectedMode);
          window.location.href = `viewer.html?atlas=${selectedAtlas}&mode=${selectedMode}`;
        } else {
          showNotification('Please select an atlas and game mode first!', false);
        }
      });

      // Initialize
      console.log('Initializing page');
      loadAtlasLabels().then(() => {
        if (categoryButtons.length > 0) {
          console.log('Triggering first category button click');
          categoryButtons[0].click();
        } else {
          console.error('No category buttons found');
          atlasChoicesDisplay.innerHTML = `<p class="no-atlas-message">${i18next.t('no_atlas_message')}</p>`;
        }
      });
    </script>
  </body>
</html>
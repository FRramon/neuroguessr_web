<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NeuroGuessr Web - Welcome</title>
    <link rel="stylesheet" href="niivue.css" />
  </head>
  <body class="index-page">
    <header>
      <div class="logo-title-container">
        <img src="/neuroguessr_web/data/neuroguessr.png" alt="NeuroGuessr Logo" class="logo" />
        <h1>NeuroGuessr</h1>
      </div>
    </header>

    <main>
      <div class="selection-container">
        <section class="atlas-selection">
          <!-- Search Bar for All Atlases -->
          <div class="search-container">
            <h3>NeuroGlossaire - Search for a brain region</h3>
            <input
              type="text"
              id="atlas-search"
              placeholder="Search all atlas regions (e.g., Amygdala, Frontal Pole...)"
              class="search-input"
            />
            <div id="search-suggestions" class="search-suggestions"></div>
          </div>
          <h2>Select Atlas</h2>
          <div class="atlas-layout">
            <div class="category-list">
              <button class="category-button" data-category="cortex">Cortical Regions</button>
              <button class="category-button" data-category="subcortical">Subcortical Regions</button>
              <button class="category-button" data-category="white-matter">White Matter Tracts</button>
              <button class="category-button" data-category="functional">Functional Networks</button>
              <button class="category-button" data-category="cerebral-arteries">Cerebral Arteries</button>
            </div>
            <div class="atlas-choices-display"></div>
          </div>
          <div style="display: none;">
            <div id="atlas-buttons-cortex">
              <button class="panel-button" data-atlas="tissues">
                <span class="atlas-info">Tissue classes <span class="atlas-description">Tissue types (CSF, WM, GM)</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="harvard-oxford">
                <span class="atlas-info">Harvard-Oxford <span class="atlas-description">Probabilistic anatomical regions</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="aal">
                <span class="atlas-info">AAL <span class="atlas-description">Automated Anatomical Labeling</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="destrieux">
                <span class="atlas-info">Destrieux <span class="atlas-description">Gyral-sulcal parcellation</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="glasser">
                <span class="atlas-info">Glasser <span class="atlas-description">Multimodal cortical parcellation</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
            </div>
            <div id="atlas-buttons-functional">
              <button class="panel-button" data-atlas="yeo7">
                <span class="atlas-info">Yeo's 7 networks <span class="atlas-description">7 resting-state functional networks</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="yeo17">
                <span class="atlas-info">Yeo's 17 networks <span class="atlas-description">17 resting-state functional networks</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
            </div>
            <div id="atlas-buttons-subcortical">
              <button class="panel-button" data-atlas="subcortical">
                <span class="atlas-info">Subcortical <span class="atlas-description">Deep brain structures</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="cerebellum">
                <span class="atlas-info">Cerebellum <span class="atlas-description">Cerebellar regions</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="thalamus">
                <span class="atlas-info">Thalamus <span class="atlas-description">Thalamic nuclei</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="HippoAmyg">
                <span class="atlas-info">Amygdala/Hippocampus <span class="atlas-description">Amygdala/Hippocampus subfields</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
            </div>
            <div id="atlas-buttons-white-matter">
              <button class="panel-button" data-atlas="JHU">
                <span class="atlas-info">JHU <span class="atlas-description">JHU's White matter tracts</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
              <button class="panel-button" data-atlas="xtract">
                <span class="atlas-info">White Matter <span class="atlas-description">FSL's White matter tracts</span></span>
                <span class="difficulty-icons">
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                  <img src="/neuroguessr_web/data/star.png" alt="Star" class="star-icon" />
                </span>
              </button>
            </div>
            <div id="atlas-buttons-cerebral-arteries">
            </div>
          </div>
        </section>

        <section class="mode-selection">
          <h2>Select Game Mode</h2>
          <div class="mode-buttons">
            <button class="mode-button" data-mode="navigation">
              <img src="/neuroguessr_web/data/boussole.png" alt="Boussole Icon" />
              Navigation
              <span class="mode-description">Identify brain regions</span>
            </button>
            <button class="mode-button" data-mode="practice">
              <img src="/neuroguessr_web/data/practice.png" alt="Practice Icon" />
              Practice
              <span class="mode-description">Learn with feedback</span>
            </button>
            <button class="mode-button" data-mode="streak">
              <img src="/neuroguessr_web/data/flame.png" alt="Flame Icon" />
              Streak
              <span class="mode-description">Test consecutive accuracy</span>
            </button>
            <button class="mode-button" data-mode="time-attack">
              <img src="/neuroguessr_web/data/chronometer.png" alt="Chronometer Icon" />
              Time Attack
              <span class="mode-description">Race against time</span>
            </button>
          </div>
          <button id="play-button" class="play-button" disabled>Play</button>
        </section>
      </div>
    </main>

    <div id="notification"></div>

    <script>
      // Get references to UI elements
      const modeButtons = document.querySelectorAll('.mode-button');
      const playButton = document.getElementById('play-button');
      const notification = document.getElementById('notification');
      const categoryButtons = document.querySelectorAll('.category-button');
      const atlasChoicesDisplay = document.querySelector('.atlas-choices-display');
      const searchInput = document.getElementById('atlas-search');
      const searchSuggestions = document.getElementById('search-suggestions');

      // Variables to store user selections
      let selectedAtlas = null;
      let selectedMode = null;
      let selectedCategoryButton = null;
      let atlasRegions = [];

      // Atlas configuration
      const atlasFiles = {
        'aal': { nii: '/neuroguessr_web/data/aal.nii.gz', json: '/neuroguessr_web/data/aal.json', viewer: 'neurotheka.html', name: 'AAL' },
        'harvard-oxford': { nii: '/neuroguessr_web/data/HarvardOxford-cort-maxprob-thr25-1mm.nii.gz', json: '/neuroguessr_web/data/harvard_oxford.json', viewer: 'neurotheka.html', name: 'Harvard-Oxford' },
        'tissues': { nii: '/neuroguessr_web/data/mni152_pveseg.nii.gz', json: '/neuroguessr_web/data/tissue.json', viewer: 'neurotheka.html', name: 'Tissue' },
        'hemisphere': { nii: '/neuroguessr_web/data/Hemispheric_space-MNI152NLin6_res-1x1x1.nii.gz', json: '/neuroguessr_web/data/hemisphere.json', viewer: 'neurotheka.html', name: 'Hemisphere' },
        'brodmann': { nii: '/neuroguessr_web/data/brodmann_grid.nii.gz', json: '/neuroguessr_web/data/brodmann.json', viewer: 'neurotheka.html', viewer: 'neurotheka.html', name: 'Brodmann' },
        'glasser': { nii: '/neuroguessr_web/data/HCP-MMP1_on_MNI152_ICBM2009a_nlin_hd.nii.gz', json: '/neuroguessr_web/data/glasser_neuroparc.json', viewer: 'neurotheka.html', name: 'Glasser' },
        'destrieux': { nii: '/neuroguessr_web/data/Destrieux_space-MNI152NLin6_res-1x1x1.nii.gz', json: '/neuroguessr_web/data/destrieux.json', viewer: 'neurotheka.html', name: 'Destrieux' },
        'schaefer': { nii: '/neuroguessr_web/data/Schaefer2018_100Parcels_7Networks_order_FSLMNI152_1mm.nii.gz', json: '/neuroguessr_web/data/schaefer100.json', viewer: 'neurotheka.html', name: 'schaefer' },     
        'yeo7': { nii: '/neuroguessr_web/data/Yeo-7-liberal_space-MNI152NLin6_res-1x1x1.nii.gz', json: '/neuroguessr_web/data/yeo7.json', viewer: 'neurotheka.html', name: 'yeo7' },
        'yeo17': { nii: '/neuroguessr_web/data/Yeo-17-liberal_space-MNI152NLin6_res-1x1x1.nii.gz', json: '/neuroguessr_web/data/yeo17.json', viewer: 'neurotheka.html', name: 'yeo17' },
        'subcortical': { nii: '/neuroguessr_web/data/ICBM2009b_asym-SubCorSeg-1mm_nn_regrid.nii.gz', json: '/neuroguessr_web/data/subcortical.json', viewer: 'neurotheka.html', name: 'Subcortical' },
        'cerebellum': { nii: '/neuroguessr_web/data/Cerebellum-MNIfnirt-maxprob-thr25-1mm.nii.gz', json: '/neuroguessr_web/data/cerebellum.json', viewer: 'neurotheka.html', name: 'Cerebellum' },
        'xtract': { nii: '/neuroguessr_web/data/xtract_web.nii.gz', json: '/neuroguessr_web/data/xtract_labels.json', viewer: 'neurotheka.html', name: 'White Matter'},
        'thalamus': { nii: '/neuroguessr_web/data/Thalamus_web.nii.gz', json: '/neuroguessr_web/data/thalamus_labels.json', viewer: 'neurotheka.html', name: 'Thalamus'},
        'HippoAmyg': { nii: '/neuroguessr_web/data/HippoAmyg_web.nii.gz', json: '/neuroguessr_web/data/HippoAmyg_labels.json', viewer: 'neurotheka.html', name: 'Hippocampus & Amygdala' },
        'JHU': { nii: '/neuroguessr_web/data/JHU_web.nii.gz', json: '/neuroguessr_web/data/JHU_labels.json', viewer: 'neurotheka.html', name: 'JHU' },
        'territories' : { nii: '/neuroguessr_web/data/ArterialAtlas_round.nii.gz', json: '/neuroguessr_web/data/artery_territories.json', viewer: 'neurotheka.html', name: 'territories' }
      };

      // Display notification
      function showNotification(message, isSuccess) {
        notification.textContent = message;
        notification.className = isSuccess ? 'success' : 'error';
        notification.style.display = 'block';
        setTimeout(() => {
          notification.style.display = 'none';
        }, 3000);
      }

      // Show previous game score if available
      const urlParams = new URLSearchParams(window.location.search);
      const score = urlParams.get('score');
      const time = urlParams.get('time');
      if (score && time) {
        const minutes = Math.floor(time / 60);
        const seconds = (time % 60).toString().padStart(2, '0');
        showNotification(`Previous Game - Accuracy: ${score}%, Time: ${minutes}m ${seconds}s`, true);
      } else if (score) {
        showNotification(`Previous Streak: ${score} regions`, true);
      }

      // Update mode buttons based on selected atlas
      function updateModeButtons() {
        modeButtons.forEach(button => {
          button.disabled = false;
          if (selectedAtlas === 'glasser') {
            button.disabled = button.dataset.mode !== 'navigation';
            if (button.disabled) button.classList.remove('selected');
          } else if (selectedAtlas === 'hemisphere') {
            button.disabled = button.dataset.mode === 'navigation';
            if (button.disabled) button.classList.remove('selected');
          }
        });
        if (selectedAtlas === 'glasser' && selectedMode && selectedMode !== 'navigation') {
          selectedMode = null;
          modeButtons.forEach(btn => btn.classList.remove('selected'));
        }
        if (selectedAtlas === 'hemisphere' && selectedMode === 'navigation') {
          selectedMode = null;
          modeButtons.forEach(btn => {
            if (btn.dataset.mode === 'navigation') btn.classList.remove('selected');
          });
        }
      }

      // Update play button state
      function updatePlayButton() {
        playButton.disabled = !(selectedAtlas && selectedMode);
        playButton.classList.toggle('enabled', !playButton.disabled);
      }

      // Load labels for all atlases
      async function loadAtlasLabels() {
        atlasRegions = [];
        for (const [atlas, { json, name }] of Object.entries(atlasFiles)) {
          try {
            const response = await fetch(json);
            if (!response.ok) throw new Error(`HTTP ${response.status} for ${atlas}`);
            const labels = await response.json();
            const regions = Object.entries(labels.labels)
              .filter(([id]) => Number(id) > 0 && Number.isInteger(Number(id)))
              .map(([id, label]) => ({
                id: Number(id),
                name: label || `Region ${id}`,
                atlas,
                atlasName: name
              }));
            atlasRegions.push(...regions);
            console.log(`Loaded ${regions.length} regions for ${atlas} (${name})`);
          } catch (error) {
            console.error(`Failed to load labels for ${atlas}:`, error);
            showNotification(`Failed to load regions for ${name}.`, false);
          }
        }
        console.log('Total regions loaded:', atlasRegions.length);
        if (atlasRegions.length === 0) {
          showNotification('No atlas regions loaded. Search disabled.', false);
          searchInput.disabled = true;
        }
      }

      // Search across all atlas regions
      function searchAtlasRegions(query) {
        searchSuggestions.innerHTML = '';
        if (!query.trim()) {
          searchSuggestions.style.display = 'none';
          return;
        }
        const lowerQuery = query.toLowerCase();
        const matches = atlasRegions
          .filter(region => region.name.toLowerCase().includes(lowerQuery))
          .sort((a, b) => {
            const aIndex = a.name.toLowerCase().indexOf(lowerQuery);
            const bIndex = b.name.toLowerCase().indexOf(lowerQuery);
            if (aIndex !== bIndex) return aIndex - bIndex;
            return a.name.length - b.name.length;
          })
        if (matches.length === 0) {
          searchSuggestions.style.display = 'none';
          return;
        }
        matches.forEach(region => {
          const suggestion = document.createElement('div');
          suggestion.className = 'search-suggestion';
          suggestion.innerHTML = `${region.name} <span style="color: #808588;">(${region.atlasName})</span>`;
          suggestion.dataset.regionId = region.id;
          suggestion.dataset.atlas = region.atlas;
          suggestion.addEventListener('click', () => {
            const viewerUrl = `${atlasFiles[region.atlas].viewer}?region=${region.id}&atlas=${region.atlas}`;
            console.log(`Navigating to: ${viewerUrl}`);
            window.location.href = viewerUrl;
          });
          searchSuggestions.appendChild(suggestion);
        });
        searchSuggestions.style.display = 'block';
      }

      // Event listeners
      searchInput.addEventListener('input', () => {
        console.log('Search input:', searchInput.value);
        searchAtlasRegions(searchInput.value);
      });

      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
          searchSuggestions.style.display = 'none';
        }
      });

      categoryButtons.forEach(button => {
        button.addEventListener('click', () => {
          console.log('Category button clicked:', button.dataset.category);
          if (selectedCategoryButton) {
            selectedCategoryButton.classList.remove('selected');
          }
          button.classList.add('selected');
          selectedCategoryButton = button;

          atlasChoicesDisplay.innerHTML = '';
          selectedAtlas = null;
          updateModeButtons();
          updatePlayButton();

          const category = button.dataset.category;
          const atlasButtonsContainer = document.getElementById(`atlas-buttons-${category}`);
          if (!atlasButtonsContainer) {
            console.error(`No container found for category: ${category}`);
            atlasChoicesDisplay.innerHTML = '<p class="no-atlas-message">Error: Atlas data not found.</p>';
            return;
          }

          const atlasButtons = atlasButtonsContainer.querySelectorAll('.panel-button');
          if (atlasButtons.length === 0) {
            console.error(`No atlas buttons found for category: ${category}`);
            atlasChoicesDisplay.innerHTML = '<p class="no-atlas-message">No atlases available for this category.</p>';
            return;
          }

          atlasButtons.forEach(template => {
            const clone = template.cloneNode(true);
            clone.addEventListener('click', () => {
              console.log('Atlas button clicked:', clone.dataset.atlas);
              atlasChoicesDisplay.querySelectorAll('.panel-button').forEach(btn => btn.classList.remove('selected'));
              clone.classList.add('selected');
              selectedAtlas = clone.dataset.atlas;
              updateModeButtons();
              updatePlayButton();
            });
            atlasChoicesDisplay.appendChild(clone);
          });
        });
      });

      modeButtons.forEach(button => {
        button.addEventListener('click', () => {
          if (!button.disabled) {
            console.log('Mode button clicked:', button.dataset.mode);
            modeButtons.forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            selectedMode = button.dataset.mode;
            updatePlayButton();
          }
        });
      });

      playButton.addEventListener('click', () => {
        if (!playButton.disabled) {
          console.log('Play button clicked:', selectedAtlas, selectedMode);
          window.location.href = `viewer.html?atlas=${selectedAtlas}&mode=${selectedMode}`;
        } else {
          showNotification('Please select an atlas and game mode first!', false);
        }
      });

      // Initialize
      console.log('Initializing page');
      loadAtlasLabels().then(() => {
        if (categoryButtons.length > 0) {
          console.log('Triggering first category button click');
          categoryButtons[0].click();
        } else {
          console.error('No category buttons found');
          atlasChoicesDisplay.innerHTML = '<p class="no-atlas-message">No atlas categories found.</p>';
        }
      });
    </script>
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93c0e331b92a53c7',t:'MTc0NjYyMjY5Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>